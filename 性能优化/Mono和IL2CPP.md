[TOC]



Unity引擎支持游戏跨平台运行，开发者无需修改游戏本身逻辑的任何代码，只需在Unity中切换游戏发布平台即可

**<font color=red>“跨平台”主要针对游戏的逻辑代码</font>**，一次编译，即可在多个平台正常运行。Unity引擎内部通过“Mono”和“IL2CPP”两种方式实现“C#代码”的“跨平台运行”

##### Mono：

**运行过程**：

**1)**.先将业务逻辑编写的C#脚本编译生成“中间语言IL”，在打包时将当前平台的“Mono虚拟机”与“中间语言IL”以及“其他第三方DLL库”一起生成“最终安装包”

**2)**.在目标平台安装完毕并启动运行，“Mono虚拟机”会自动将“中间语言IL”和“其他第三方DLL库”编译成该平台可识别的“机器码” —— **<font color=blue>即目标平台的汇编机器码</font>**，根据该“机器码”运行游戏。如此即可实现游戏的“跨平台运行”

<img src="https://gitee.com/kakaix892/image-host/raw/main/Typora/image-20231113133815615.png" alt="image-20231113133815615" style="zoom:80%;" />

将多种语言编写的脚本通过“对应语言的编译器”生成“中间语言IL”，和其他导入的第三方DLL库一起，通过“Mono虚拟机”解析得到“目标平台的机器码”并放入内存中，由此运行该游戏

**优点**：

**1)**.构建应用速度快。由于仅将“已适配完成的Mono虚拟机”和“编译完成的业务逻辑代码的中间语言IL、第三方DLL库”打包成“最终安装文件”，因此构建应用速度很快

**2)**.由于“最终安装包”中包含“Mono虚拟机”，因此该应用可以“跨平台运行”

**缺点**：

**1)**.“Mono虚拟机”需要针对不同的平台进行适配，虽然该适配过程由Unity负责，但由于该“Mono虚拟机”需要负责“中间语言IL”以及“第三方DLL库”的编译，**<font color=red>功能非常复杂，因此各个平台的适配难度极大</font>**，且部分平台完全不支持“Mono虚拟机”，如“WebGL”和“UWP”

**PS**：当在Unity中切换目标平台时，其主要是切换“Mono虚拟机”的平台适配，游戏业务逻辑的代码并不会有修改

**2)**.“Mono版本”与Unity版本相绑定，无法独立升级，如Unity2018的Mono版本为“Mono 2.0”，Unity2020的Mono版本为“Mono 5.11”，而部分C#游戏代码可能会用到最新的C#特性，如UniTask等，其需要更新相应的“Mono版本”，因此只能将整个项目的Unity版本进行升级才能支持

**3)**.由于游戏运行时需要通过“Mono虚拟机”编译“中间语言IL”得到“目标平台的机器码”，且通常是“一边编译，一边运行”，即**<font color=blue>“JIT编译”</font>**，**<font color=red>因此游戏运行速度较慢</font>**。且此过程必然需要“目标平台的内存读写权限”——将“中间语言IL”编译得到“机器码”存放于内存中，而IOS平台已封禁“内存的执行权限”，因此其不支持“JIT编译”，故IOS平台通常并不使用“Mono脚本后端”



##### IL2CPP

**运行过程**：

1).将各个语言编写的脚本通过其“对应的编译器”生成“中间语言IL”，和所有其他“第三方DLL库”一起通过“IL2CPP.exe”编译得到“C++文件”

<img src="https://gitee.com/kakaix892/image-host/raw/main/Typora/image-20231113160941613.png" alt="image-20231113160941613" style="zoom:80%;" />

**PS**：“IL2CPP.exe”在Unity安装目录下：`Contents / Frameworks / il2cpp / build`

2).利用**<font color=red>目标平台自带的C++编译器</font>**对“C++文件”中的代码进行优化，**<font color=red>裁剪部分不需要的代码</font>**(**进一步减小安装包大小**)，同时生成目标平台的机器码——即汇编语言的机器码，最后和“IL2CPP虚拟机”一起打包得到“安装包文件”

3).在目标平台安装并启动游戏，通过“IL2CPP虚拟机”和“机器码汇编文件”运行游戏

<img src="https://gitee.com/kakaix892/image-host/raw/main/Typora/image-20231113140244108.png" alt="image-20231113140244108" style="zoom:80%;" />

**优点**：

**1)**.可以采用“代码裁剪”减少部分不需要的代码，进一步降低安装包的大小。但代码裁剪级别尽量保持为“low”，“高级别的代码裁剪”有可能会将部分重要的代码也裁切，导致游戏出现异常

**2)**.由于游戏使用该平台的原生汇编码运行，因此运行速度很快，相比于“Mono方式”，运行速度有“1.5 - 2”倍的提升

**3)**.**<font color=blue>“IL2CPP虚拟机”不需要负责“中间语言IL”的编译，仅负责游戏运行时内存中各个对象的GC管理，功能简单，因此在各个平台间移植也非常方便</font>**

**缺点**：

**1)**.由于需要针对目标平台生成原生汇编机器码，因此**<font color=blue>构建应用的速度较慢</font>**，通常**<font color=red>只在打游戏的“正式Release包”时才使用本方式，日常开发流程中则默认使用“Mono方式”</font>**

**2)**.只支持“AOT”编译，必须将所有代码编译生成“目标平台的原生汇编码”，不支持在游戏运行时“边编译边运行”，因此也不需要内存的“映射权限”。在开发中，针对IOS平台默认使用“IL2CPP”方式，而安卓平台则根据需求自由选择“Mono”或“IL2CPP”均可



##### 代码编译方式：

“代码编译”方式大体有两种，分别为“JIT编译”和“AOT编译”：

###### JIT编译：

Just In Time(及时编译)，在程序运行时将“中间语言IL”通过“虚拟机”编译得到“目标平台的原生机器码”映射到内存中，通过执行这些机器码来运行游戏

优点：可以根据程序运行时硬件的实时情况动态编译生成最优的机器指令，充分利用硬件性能

缺点：动态编译会占用额外的资源和时间，可能导致进程卡顿；并且IOS系统封禁了内存的执行权限，无法使用JIT编译

###### AOT编译：

Ahead Of Time(提前编译)，程序运行前提前生成该平台的原生机器码

优点：程序运行时直接执行机器码汇编文件，速度快，性能好

缺点：构建速度慢































